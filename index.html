<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Data Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .kpi-value { font-size: 2rem; font-weight: bold; color: #0d6efd; }
        .kpi-label { font-size: 0.9rem; color: #6c757d; text-transform: uppercase; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <h4 class="mt-3">Loading Data...</h4>
        <p class="text-muted">Please ensure this file is served via a local server (e.g., python -m http.server)</p>
    </div>

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">âš¡ Electricity Analytics Dashboard</span>
            <div class="d-flex gap-2">
                <select id="yearFilter" class="form-select form-select-sm" style="width: auto;">
                    </select>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="kpi-label">Total Consumption (kWh)</div>
                    <div class="kpi-value" id="totalUsage">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="kpi-label">Total Users</div>
                    <div class="kpi-value" id="totalUsers">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="kpi-label">Highest Usage Province</div>
                    <div class="kpi-value fs-4" id="topProvince">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="kpi-label">Avg Usage Per User</div>
                    <div class="kpi-value fs-4" id="avgUsage">-</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card p-3">
                    <h5>Top 10 Provinces by Consumption</h5>
                    <canvas id="topProvincesChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Usage by Sector</h5>
                    <canvas id="sectorUsageChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>User Distribution by Sector</h5>
                    <canvas id="sectorUsersChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>Consumption vs. Users Correlation</h5>
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card p-3">
                    <h5>Detailed Data Breakdown</h5>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover">
                            <thead class="table-light position-sticky top-0">
                                <tr>
                                    <th>Province</th>
                                    <th>Total Usage (kWh)</th>
                                    <th>Res. Usage</th>
                                    <th>Biz. Usage</th>
                                    <th>Total Users</th>
                                    <th>Res. Users</th>
                                    <th>Biz. Users</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Data Storage
        let rawUsageData = [];
        let rawUserData = [];
        let combinedData = [];
        let charts = {};

        // Configuration
        const USAGE_FILE = 'electricity_usages_en.json';
        const USERS_FILE = 'electricity_users_en.json';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadData();
                populateYears();
                processData();
                updateDashboard();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error(error);
                alert("Error loading data. Check console for details. Ensure you are running a local server.");
                document.getElementById('loading').innerHTML = `
                    <div class='text-danger text-center p-4'>
                        <h3>Failed to Load Data</h3>
                        <p>1. Ensure ${USAGE_FILE} and ${USERS_FILE} are in this folder.</p>
                        <p>2. You MUST run a local server (CORS policy blocks direct file access).</p>
                        <code class='bg-light p-2'>python -m http.server</code>
                    </div>`;
            }
        });

        // 1. Fetch Data
        async function loadData() {
            const [usageRes, userRes] = await Promise.all([
                fetch(USAGE_FILE),
                fetch(USERS_FILE)
            ]);
            
            if (!usageRes.ok || !userRes.ok) throw new Error("File not found");

            const usageJson = await usageRes.json();
            const userJson = await userRes.json();

            // Handle structure: Some JSONs might be wrapped in keys like "Sheet1"
            rawUsageData = Array.isArray(usageJson) ? usageJson : (usageJson.Sheet1 || Object.values(usageJson)[0]);
            rawUserData = Array.isArray(userJson) ? userJson : (userJson.Sheet1 || Object.values(userJson)[0]);
        }

        // 2. Setup Controls
        function populateYears() {
            const years = [...new Set(rawUsageData.map(d => d.year))].sort((a,b) => b-a);
            const select = document.getElementById('yearFilter');
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.innerText = `Year: ${y}`;
                select.appendChild(opt);
            });
            select.addEventListener('change', () => {
                processData();
                updateDashboard();
            });
        }

        // 3. Process Data
        function processData() {
            const selectedYear = parseInt(document.getElementById('yearFilter').value);

            // Filter by year
            const usageByYear = rawUsageData.filter(d => d.year === selectedYear);
            const userByYear = rawUserData.filter(d => d.year === selectedYear);

            // Merge datasets on Province Code
            combinedData = usageByYear.map(usage => {
                const user = userByYear.find(u => u.province_code === usage.province_code) || {};
                
                // Aggregates
                const totalUsage = (usage.residential_kwh || 0) + 
                                   (usage.small_business_kwh || 0) + 
                                   (usage.medium_business_kwh || 0) + 
                                   (usage.large_business_kwh || 0) +
                                   (usage.specialized_business_kwh || 0);

                const totalUsers = (user.residential_count || 0) + 
                                   (user.small_business_count || 0) + 
                                   (user.medium_business_count || 0) + 
                                   (user.large_business_count || 0) +
                                   (user.specialized_business_count || 0);

                return {
                    ...usage,
                    ...user, // Merge user counts
                    totalUsage: totalUsage,
                    totalUsers: totalUsers,
                    businessUsage: (usage.small_business_kwh || 0) + (usage.medium_business_kwh || 0) + (usage.large_business_kwh || 0),
                    businessUsers: (user.small_business_count || 0) + (user.medium_business_count || 0) + (user.large_business_count || 0)
                };
            });
            
            // Sort by usage descending
            combinedData.sort((a, b) => b.totalUsage - a.totalUsage);
        }

        // 4. Update UI
        function updateDashboard() {
            updateKPIs();
            renderTopProvincesChart();
            renderSectorUsageChart();
            renderSectorUsersChart();
            renderScatterChart();
            renderTable();
        }

        function updateKPIs() {
            const totalKwh = combinedData.reduce((sum, d) => sum + d.totalUsage, 0);
            const totalUsers = combinedData.reduce((sum, d) => sum + d.totalUsers, 0);
            const top = combinedData[0];

            document.getElementById('totalUsage').innerText = (totalKwh / 1_000_000).toLocaleString(undefined, { maximumFractionDigits: 1 }) + " M";
            document.getElementById('totalUsers').innerText = totalUsers.toLocaleString();
            document.getElementById('topProvince').innerText = top ? top.province_name : '-';
            
            const avg = totalUsers > 0 ? (totalKwh / totalUsers).toFixed(0) : 0;
            document.getElementById('avgUsage').innerText = parseInt(avg).toLocaleString() + " kWh";
        }

        // --- Charts Helper ---
        function createOrUpdateChart(canvasId, config) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(ctx, config);
        }

        function renderTopProvincesChart() {
            const top10 = combinedData.slice(0, 10);
            createOrUpdateChart('topProvincesChart', {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.province_name),
                    datasets: [{
                        label: 'Total Consumption (kWh)',
                        data: top10.map(d => d.totalUsage),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderSectorUsageChart() {
            // Aggregate totals for the whole country/selection
            const totals = {
                Residential: combinedData.reduce((s, d) => s + (d.residential_kwh || 0), 0),
                SmallBiz: combinedData.reduce((s, d) => s + (d.small_business_kwh || 0), 0),
                MediumBiz: combinedData.reduce((s, d) => s + (d.medium_business_kwh || 0), 0),
                LargeBiz: combinedData.reduce((s, d) => s + (d.large_business_kwh || 0), 0),
                Special: combinedData.reduce((s, d) => s + (d.specialized_business_kwh || 0), 0),
            };

            createOrUpdateChart('sectorUsageChart', {
                type: 'doughnut',
                data: {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#36a2eb', '#ffcd56', '#ff9f40', '#4bc0c0', '#9966ff']
                    }]
                }
            });
        }

        function renderSectorUsersChart() {
            const totals = {
                Residential: combinedData.reduce((s, d) => s + (d.residential_count || 0), 0),
                SmallBiz: combinedData.reduce((s, d) => s + (d.small_business_count || 0), 0),
                MediumBiz: combinedData.reduce((s, d) => s + (d.medium_business_count || 0), 0),
                LargeBiz: combinedData.reduce((s, d) => s + (d.large_business_count || 0), 0),
                Other: combinedData.reduce((s, d) => s + (d.government_state_enterprise_count || 0), 0),
            };

            createOrUpdateChart('sectorUsersChart', {
                type: 'pie',
                data: {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#36a2eb', '#ffcd56', '#ff9f40', '#4bc0c0', '#c9cbcf']
                    }]
                }
            });
        }

        function renderScatterChart() {
            // Plot Users vs Usage for every province
            const points = combinedData.map(d => ({
                x: d.totalUsers,
                y: d.totalUsage,
                province: d.province_name // Custom property
            }));

            createOrUpdateChart('scatterChart', {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Province Distribution',
                        data: points,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Number of Users' } },
                        y: { title: { display: true, text: 'Usage (kWh)' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return `${point.province}: Users ${point.x.toLocaleString()}, Usage ${point.y.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            combinedData.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.province_name}</td>
                    <td>${d.totalUsage.toLocaleString()}</td>
                    <td>${(d.residential_kwh || 0).toLocaleString()}</td>
                    <td>${d.businessUsage.toLocaleString()}</td>
                    <td>${d.totalUsers.toLocaleString()}</td>
                    <td>${(d.residential_count || 0).toLocaleString()}</td>
                    <td>${d.businessUsers.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>